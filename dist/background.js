(()=>{"use strict";chrome.action.onClicked.addListener((e=>{"number"==typeof e.id&&chrome.tabs.sendMessage(e.id,{type:"getTextQuoteSelectorfromSelection"})})),chrome.runtime.onMessage.addListener((async(e,t)=>{if("ready"!==e.type);else{if("number"!=typeof t.tab?.id)return;const n=await fetch(`https://scrapbox.io/api/pages/anno/${encodeURIComponent(e.url)}`);if(!n.ok)throw new Error(`Failed to fetch page: ${n.status}`);const o={type:"inject",configs:(await n.json()).lines.flatMap((t=>[...t.text.matchAll(/\[.*?\s(.*?)\]/g)].flatMap((n=>{try{const o=new URLSearchParams(new URL(n[1]).hash),a=o.get("anno_e");return a?[{textQuoteSelector:{prefix:o.get("anno_p")??void 0,exact:a,suffix:o.get("anno_s")??void 0},url:`https://scrapbox.io/anno/${encodeURIComponent(e.url)}#${t.id}`}]:[]}catch{return[]}}))))};chrome.tabs.sendMessage(t.tab.id,o)}}))})();